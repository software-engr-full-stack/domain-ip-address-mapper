# https://ftp.gnu.org/old-gnu/Manuals/make-3.80/html_node/make_17.html
_cm_ubfoc_tvm_mkfile_dir := $(dir $(abspath $(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))))
_cm_ubfoc_tvm_mkfile_dir := $(_cm_ubfoc_tvm_mkfile_dir:/=)

_cm_ubfoc_tvm_app_dir := $(abspath ${_cm_ubfoc_tvm_mkfile_dir}/../../../../..)

# TODO: investigate why this doesn't work.
#   https://www.systutorials.com/how-to-get-the-full-path-and-directory-of-a-makefile-itself/
# _cm_ubfoc_tvm_mkfile_dir := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

_cm_ubfoc_tvm_config_dir := $(abspath ${_cm_ubfoc_tvm_mkfile_dir}/../config)

_cm_ubfoc_tvm_image_name := test-vm
_cm_ubfoc_tvm_container_name := test-vm-container

_cm_ubfoc_tvm_db_password := t3st-vm-db-passw0rd
_cm_ubfoc_tvm_db_port := 6338

_cm_ubfoc_tvm_create_db_config_file := ${_cm_ubfoc_tvm_app_dir}/lib/create-db-config-file.py
_cm_ubfoc_tvm_db_config_base := ${_cm_ubfoc_tvm_config_dir}/docker-db.yml
_cm_ubfoc_tvm_tmp_autogen_dir := $(abspath ${_cm_ubfoc_tvm_mkfile_dir}/../tmp/autogenerated)
_cm_ubfoc_tvm_db_config_within_containers := ${_cm_ubfoc_tvm_tmp_autogen_dir}/db-within-containers.yml
_cm_ubfoc_tvm_db_config_host_to_containers := ${_cm_ubfoc_tvm_tmp_autogen_dir}/db-host-to-containers.yml
_cm_ubfoc_tvm_docker_db_env := ${_cm_ubfoc_tvm_tmp_autogen_dir}/docker-db.env

cm-ubuntu-focal-test-vm-generate-config-files:
	rm -rf "${_cm_ubfoc_tvm_tmp_autogen_dir}"; \
	mkdir -p "${_cm_ubfoc_tvm_tmp_autogen_dir}" && \
	printf "DB_PASSWORD=${_cm_ubfoc_tvm_db_password}\nDB_HOST_PORT=${_cm_ubfoc_tvm_db_port}\nDOCKER_DATA_DIR=/var/local/lib/docker/\n" \
		> ${_cm_ubfoc_tvm_docker_db_env} && \
	${_cm_ubfoc_tvm_create_db_config_file} \
		--input-config-file "${_cm_ubfoc_tvm_db_config_base}" \
		--modifications-to-default '{"password": "${_cm_ubfoc_tvm_db_password}", "host": "db"}' \
		--output-config-file "${_cm_ubfoc_tvm_db_config_within_containers}" && \
	${_cm_ubfoc_tvm_create_db_config_file} \
		--input-config-file "${_cm_ubfoc_tvm_db_config_base}" \
		--modifications-to-default '{"password": "${_cm_ubfoc_tvm_db_password}", "host": "127.0.0.1", "port": ${_cm_ubfoc_tvm_db_port}}' \
		--output-config-file "${_cm_ubfoc_tvm_db_config_host_to_containers}"
